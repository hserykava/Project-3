<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Human Balance Animation - Paired Comparison</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <h1>Compare Sway Between Two Conditions</h1>
  <h2>Visualize real-time balance sway across experimental conditions</h2>

  <div class="controls">
    <div class="arrow" id="leftArrow">◀</div>
    <div class="pair-label" id="pairLabel">ECL1 vs ECL2</div>
    <div class="arrow" id="rightArrow">▶</div>
    <button id="playBtn">▶️ Play</button>
    <button id="pauseBtn">⏸️ Pause</button>
  </div>

  <svg id="humanAnimation" width="1000" height="600"></svg>

  <div id="tooltip" class="tooltip" style="opacity: 0;"></div>

  <div class="controls">
    <button class="button" id="play">Play</button>
    <button class="button" id="pause">Pause</button>
    <button class="button" id="restart">Restart</button>
    <button class="button" id="skip">Skip</button>
  </div>

  <div id="chart"></div>

  <script>
    const svg = d3.select("#humanAnimation");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const centerX1 = width / 4;
    const centerX2 = (3 * width) / 4;
    const baseY = height / 2 + 150;
    const swayScaleX = 1000;
    const swayScaleY = 1000;

    let data = [], animationTimer, currentIndex = 0, swayData1 = [], swayData2 = [], isPlaying = false;
    let currentPairIndex = 0;

    const pairs = [
      {label: "ECL1 vs ECL2", categories: ["ECL1", "ECL2"]},
      {label: "ECR vs ECN", categories: ["ECR", "ECN"]},
      {label: "WOR vs WON", categories: ["WOR", "WON"]},
      {label: "WOL1 vs WOL2", categories: ["WOL1", "WOL2"]},
      {label: "WR vs WN", categories: ["WR", "WN"]},
      {label: "WL1 vs WL2", categories: ["WL1", "WL2"]}
    ];

    const body1 = svg.append("line").attr("stroke", "black").attr("stroke-width", 10);
    const head1 = svg.append("circle").attr("r", 30).attr("fill", "black");
    const leftArm1 = svg.append("line").attr("stroke", "black").attr("stroke-width", 6);
    const rightArm1 = svg.append("line").attr("stroke", "black").attr("stroke-width", 6);
    const leftLeg1 = svg.append("line").attr("stroke", "black").attr("stroke-width", 10);
    const rightLeg1 = svg.append("line").attr("stroke", "black").attr("stroke-width", 10);

    const body2 = svg.append("line").attr("stroke", "black").attr("stroke-width", 10);
    const head2 = svg.append("circle").attr("r", 30).attr("fill", "black");
    const leftArm2 = svg.append("line").attr("stroke", "black").attr("stroke-width", 6);
    const rightArm2 = svg.append("line").attr("stroke", "black").attr("stroke-width", 6);
    const leftLeg2 = svg.append("line").attr("stroke", "black").attr("stroke-width", 10);
    const rightLeg2 = svg.append("line").attr("stroke", "black").attr("stroke-width", 10);

    d3.json("data/sway_data.json").then(json => {
      data = json;
      updatePairLabel();
      updateSwayData();
      drawCurrentFigures();
    });

    document.getElementById('leftArrow').addEventListener('click', () => {
      currentPairIndex = (currentPairIndex - 1 + pairs.length) % pairs.length;
      updatePairLabel();
      updateSwayData();
      if (isPlaying) {
        currentIndex = 0;
        animateHumans();
      } else {
        drawCurrentFigures();
      }
    });

    document.getElementById('rightArrow').addEventListener('click', () => {
      currentPairIndex = (currentPairIndex + 1) % pairs.length;
      updatePairLabel();
      updateSwayData();
      if (isPlaying) {
        currentIndex = 0;
        animateHumans();
      } else {
        drawCurrentFigures();
      }
    });

    function updatePairLabel() {
      document.getElementById('pairLabel').textContent = pairs[currentPairIndex].label;
      const labelMapping = {
        "ECR vs ECN": "Eyes closed, VR on: unmodified Mozart's Jupiter vs no music",
        "ECL1 vs ECL2": "Eyes closed, VR off: Mozart's Jupiter with loudness shifted at 0.1Hz vs 0.25Hz",
        "WOR vs WON": "VR on: unmodified Mozart's Jupiter vs no music",
        "WOL1 vs WOL2": "VR on: 0.1Hz vs 0.25Hz",
        "WR vs WN": "VR translating at 0.1Hz: no music vs unmodified Mozart's Jupiter",
        "WL1 vs WL2": "VR translating at 0.1Hz: Mozart's Jupiter with loudness shifted at 0.1Hz vs 0.25Hz"
      };
      const graphPairKey = labelMapping[pairs[currentPairIndex].label];
      if (graphPairKey) {
        step = 0;
        clearInterval(intervalId);
        updateGraph(graphPairKey);
      }
    }

    function updateSwayData() {
      const selectedPair = pairs[currentPairIndex].categories;
      swayData1 = data.filter(d => d.Description === selectedPair[0]);
      swayData2 = data.filter(d => d.Description === selectedPair[1]);
      clearInterval(animationTimer);
      currentIndex = 0;
    }

    function drawHuman(centerX, offsetX, offsetY, body, head, leftArm, rightArm, leftLeg, rightLeg) {
      const torsoTopX = centerX + offsetX;
      const torsoTopY = baseY - 120 + offsetY;
      const torsoBottomX = centerX;
      const torsoBottomY = baseY;

      body.attr("x1", torsoBottomX).attr("y1", torsoBottomY)
          .attr("x2", torsoTopX).attr("y2", torsoTopY);

      head.attr("cx", torsoTopX).attr("cy", torsoTopY - 35);

      leftArm.attr("x1", torsoTopX).attr("y1", torsoTopY)
             .attr("x2", torsoTopX - 60).attr("y2", torsoTopY + 40);

      rightArm.attr("x1", torsoTopX).attr("y1", torsoTopY)
              .attr("x2", torsoTopX + 60).attr("y2", torsoTopY + 40);

      leftLeg.attr("x1", centerX - 20).attr("y1", baseY + 80)
             .attr("x2", centerX).attr("y2", baseY);

      rightLeg.attr("x1", centerX + 20).attr("y1", baseY + 80)
              .attr("x2", centerX).attr("y2", baseY);
    }

    function drawCurrentFigures() {
      if (swayData1.length > 0 && swayData2.length > 0) {
        const d1 = swayData1[0];
        const d2 = swayData2[0];

        const offsetX1 = d1.CoPx * swayScaleX;
        const offsetY1 = -d1.CoPy * swayScaleY;

        const offsetX2 = d2.CoPx * swayScaleX;
        const offsetY2 = -d2.CoPy * swayScaleY;

        drawHuman(centerX1, offsetX1, offsetY1, body1, head1, leftArm1, rightArm1, leftLeg1, rightLeg1);
        drawHuman(centerX2, offsetX2, offsetY2, body2, head2, leftArm2, rightArm2, leftLeg2, rightLeg2);
      }
    }

    function animateHumans() {
      clearInterval(animationTimer);
      animationTimer = setInterval(() => {
        if (currentIndex >= swayData1.length || currentIndex >= swayData2.length) {
          clearInterval(animationTimer);
          isPlaying = false;
          return;
        }
        const d1 = swayData1[currentIndex];
        const d2 = swayData2[currentIndex];

        const offsetX1 = d1.CoPx * swayScaleX;
        const offsetY1 = -d1.CoPy * swayScaleY;

        const offsetX2 = d2.CoPx * swayScaleX;
        const offsetY2 = -d2.CoPy * swayScaleY;

        drawHuman(centerX1, offsetX1, offsetY1, body1, head1, leftArm1, rightArm1, leftLeg1, rightLeg1);
        drawHuman(centerX2, offsetX2, offsetY2, body2, head2, leftArm2, rightArm2, leftLeg2, rightLeg2);

        currentIndex++;
      }, 70);
    }
  </script>
</body>
</html>
