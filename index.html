<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Human Balance Animation</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    svg { border: 1px solid #ccc; background-color: #f9f9f9; }
    .controls { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Human Balance Animation: CoP Sway</h1>
  <div class="controls">
    <label for="sampleSelect">Select Sample:</label>
    <select id="sampleSelect"></select>
    <label><input type="radio" name="condition" value="WON" checked> WON</label>
    <label><input type="radio" name="condition" value="WR"> WR</label>
    <button id="playBtn">▶️ Play</button>
    <button id="pauseBtn">⏸️ Pause</button>
  </div>
  <svg width="600" height="500"></svg>

  <script>
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const centerX = width / 2;
    const baseY = height / 2 + 100;
    const swayScale = 400;

    let data = [], animationTimer, currentIndex = 0, swayData = [], isPlaying = false;

    // Body parts
    const body = svg.append("line").attr("stroke", "black").attr("stroke-width", 6);
    const head = svg.append("circle").attr("r", 10).attr("fill", "black");
    const leftArm = svg.append("line").attr("stroke", "black").attr("stroke-width", 4);
    const rightArm = svg.append("line").attr("stroke", "black").attr("stroke-width", 4);
    const leftLeg = svg.append("line").attr("stroke", "gray").attr("stroke-width", 6);
    const rightLeg = svg.append("line").attr("stroke", "gray").attr("stroke-width", 6);

    d3.json("data/sway_data.json").then(json => {
      data = json;
      const samples = Array.from(new Set(data.map(d => d.Sample)));

      d3.select("#sampleSelect")
        .selectAll("option")
        .data(samples)
        .enter()
        .append("option")
        .text(d => d);

      d3.selectAll("input[name='condition']").on("change", () => {
        updateSwayData();
        if (isPlaying) animateHuman();
      });

      d3.select("#sampleSelect").on("change", () => {
        updateSwayData();
        if (isPlaying) animateHuman();
      });

      d3.select("#playBtn").on("click", () => {
        isPlaying = true;
        currentIndex = 0;
        animateHuman();
      });

      d3.select("#pauseBtn").on("click", () => {
        clearInterval(animationTimer);
        isPlaying = false;
      });

      updateSwayData();
      drawInitialFigure();
    });

    function updateSwayData() {
      const sample = d3.select("#sampleSelect").property("value");
      const condition = document.querySelector('input[name="condition"]:checked').value;
      swayData = data.filter(d => d.Sample === sample && d.Description === condition);
      currentIndex = 0;
    }

    function drawInitialFigure() {
      const torsoTopX = centerX;
      const torsoTopY = baseY - 100;
      const torsoBottomX = centerX;
      const torsoBottomY = baseY;

      body.attr("x1", torsoBottomX).attr("y1", torsoBottomY)
          .attr("x2", torsoTopX).attr("y2", torsoTopY);

      head.attr("cx", torsoTopX).attr("cy", torsoTopY - 15);

      leftArm.attr("x1", torsoTopX).attr("y1", torsoTopY)
             .attr("x2", torsoTopX - 20).attr("y2", torsoTopY + 20);

      rightArm.attr("x1", torsoTopX).attr("y1", torsoTopY)
              .attr("x2", torsoTopX + 20).attr("y2", torsoTopY + 20);

      leftLeg.attr("x1", centerX - 10).attr("y1", baseY + 40)
             .attr("x2", centerX).attr("y2", baseY);

      rightLeg.attr("x1", centerX + 10).attr("y1", baseY + 40)
              .attr("x2", centerX).attr("y2", baseY);
    }

    function animateHuman() {
      clearInterval(animationTimer);
      animationTimer = setInterval(() => {
        if (currentIndex >= swayData.length) {
          clearInterval(animationTimer);
          isPlaying = false;
          return;
        }

        const d = swayData[currentIndex];
        const offsetX = d.CoPx * swayScale;
        const offsetY = -d.CoPy * swayScale;

        const torsoTopX = centerX + offsetX;
        const torsoTopY = baseY - 100 + offsetY;
        const torsoBottomX = centerX;
        const torsoBottomY = baseY;

        body.attr("x1", torsoBottomX).attr("y1", torsoBottomY)
            .attr("x2", torsoTopX).attr("y2", torsoTopY);

        head.attr("cx", torsoTopX).attr("cy", torsoTopY - 15);

        leftArm.attr("x1", torsoTopX).attr("y1", torsoTopY)
               .attr("x2", torsoTopX - 20).attr("y2", torsoTopY + 20);

        rightArm.attr("x1", torsoTopX).attr("y1", torsoTopY)
                .attr("x2", torsoTopX + 20).attr("y2", torsoTopY + 20);

        leftLeg.attr("x1", centerX - 10).attr("y1", baseY + 40)
               .attr("x2", centerX).attr("y2", baseY);

        rightLeg.attr("x1", centerX + 10).attr("y1", baseY + 40)
                .attr("x2", centerX).attr("y2", baseY);

        currentIndex++;
      }, 15);
    }
  </script>
</body>
</html>
